# Shad MTS MLOps Project 2

Это учебный проект построения системы обнаружения мошеннических транзакций на основе потоковых данных с использованием Kafka, PostgreSQL, Streamlit UI и ML-модели (CatBoost). Проект реализует полный цикл обработки данных от загрузки до визуализации результатов.

Датасет можно найти [здесь](https://www.kaggle.com/competitions/teta-ml-1-2025/data).

---

## Архитектура

Проект состоит из следующих сервисов:

| Сервис           | Описание |
|------------------|----------|
| **Kafka**        | Шина сообщений для потоковой передачи данных между компонентами |
| **Zookeeper**    | Управление кластером Kafka |
| **Kafka UI**     | Веб-интерфейс для мониторинга Kafka |
| **fraud_detector** | Микросервис, выполняющий предобработку данных и инференс модели CatBoost |
| **scoring_writer** | Потребитель Kafka, сохраняет результаты скоринга в PostgreSQL |
| **PostgreSQL**   | Хранилище результатов скоринга |
| **interface**    | Веб-интерфейс (Streamlit) для загрузки файлов и просмотра результатов |

---

## Структура проекта

```
.
├── fraud_detector/           # Микросервис скоринга транзакций
│   ├── app/
│   ├── models/
│   ├── src/
│   ├── Dockerfile
│   └── requirements.txt
├── interface/                # Веб-интерфейс (Streamlit)
│   ├── app.py
│   ├── Dockerfile
│   └── requirements.txt
├── scoring_writer/           # Сервис записи результатов в Postgres
│   ├── app.py
│   ├── Dockerfile
│   └── requirements.txt
│
├── docker-compose.yaml       # Основной файл Docker Compose
├── .env                      # Файл с переменными окружения (не в репозитории)
├── .env.example              # Пример файла переменных окружения
├── .gitignore                # Игнорирование приватных и ненужных файлов
└── README.md                 # Readme файл
```

---

## Функциональность

### 1. Загрузка CSV-файла с транзакциями
- Поддерживается только формат `.csv`.
- Каждая строка отправляется в Kafka топик `transactions` с уникальным `transaction_id`.

### 2. Обработка и скоринг транзакций
- Сервис `fraud_detector` считывает данные из топика `transactions`.
- Выполняет препроцессинг и предсказание с помощью модели CatBoost.
- Результат (`score`, `fraud_flag`) отправляется в топик `scoring`.

### 3. Хранение результатов
- Сервис `scoring_writer` читает топик `scoring`.
- Сохраняет результаты в PostgreSQL таблицу `scores`.

### 4. Визуализация результатов
- Через кнопку "Посмотреть результаты" можно:
  - Посмотреть **10 последних фродовых транзакций** (`fraud_flag == 1`)
  - Посмотреть **гистограмму распределения скоров** по последним 100 транзакциям

---

## Технологии

- **Python 3.9+**
- **ML**: CatBoost, pandas, numpy
- **Kafka**: потоковая обработка данных
- **PostgreSQL**: хранение результатов
- **Streamlit**: визуализация и пользовательский интерфейс
- **Docker / Docker Compose**: оркестрация микросервисов

---

## Как запустить проект

### 1. Клонируйте репозиторий

```bash
git clone https://github.com/OrlovAlexandr/shad_mlops_2.git
cd shad_mlops_2
```

### 2. Создайте `.env` файл

Скопируйте шаблон `.env.example` в `.env`:

```bash
cp .env.example .env
```

Не забудьте изменить логины/пароли при необходимости.

### 3. Запустите контейнеры

```bash
docker-compose up --build
```
Убедитесь, что у вас установлены:
   - [Docker](https://docs.docker.com/engine/install/)
   - [Docker Compose](https://docs.docker.com/compose/install/)


Первый запуск может занять несколько минут — образы будут скачаны и собраны.



## Доступные сервисы

| Сервис         | URL                             |
|----------------|---------------------------------|
| **Streamlit UI** | http://localhost:8501           |
| **Kafka UI**     | http://localhost:8080           |
| **PostgreSQL**   | host: `postgres`, port: `5432` |

---

## Таблица в PostgreSQL

Таблица `scores` содержит следующие поля:

| Поле             | Тип          | Описание                                |
|------------------|--------------|-----------------------------------------|
| id               | SERIAL       | Уникальный ID                           |
| transaction_id   | TEXT         | Идентификатор транзакции                |
| score            | FLOAT        | Вероятность мошенничества (порог = 0,5) |
| fraud_flag       | INT          | 1 — мошенничество, 0 — норма            |
| created_at       | TIMESTAMP    | Дата и время записи                     |

---

## Как использовать

1. Перейдите в браузере по адресу: [http://localhost:8501](http://localhost:8501)
2. Загрузите CSV файл с данными транзакций.
3. Нажмите "Отправить", чтобы данные попали в Kafka.
4. После обработки можно нажать "Посмотреть результаты":
   - Отобразятся последние 10 фродовых транзакций
   - Будет показана гистограмма скоров последних 100 транзакций

---

### Очистка после тестирования

Остановите и удалите контейнеры:
```bash
docker-compose down -v
```

Если нужно очистить данные БД:
```bash
docker volume rm $(docker volume ls -q | grep postgres_data)
```
